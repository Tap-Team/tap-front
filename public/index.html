<html>
<head></head>
<body>
  <form>
    <input type='file' accept='image/*' multiple='multiple' name='imgs[]'>
    <button type='submit'>送信</button>
  </form>

  <div id="token"></div>

  <script src='https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js'></script>
  <script src='https://www.gstatic.com/firebasejs/7.5.0/firebase-storage.js'></script>
  <script>
    filename = "";

    //firebase初期化
    var firebaseConfig = {
      apiKey: 'AIzaSyCki9YaxV17q6tPE1qU3x-rYaPdi3oo3d0',
      projectId: 'tap-f4f38',
      storageBucket: 'tap-f4f38.appspot.com',
    }
    firebase.initializeApp(firebaseConfig);

    //formのsubmitにイベント設定
    var form = document.querySelector('form');
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      var imgs = form.querySelector('input');
      var uploads = [];
      for (var file of imgs.files) {
          //選択したファイルのファイル名を使うが、場合によってはかぶるので注意
        var storageRef = firebase.storage().ref('tmp/' + file.name);
        filename = file.name
        uploads.push(storageRef.put(file));
      }
      //すべての画像のアップロード完了を待つ
      Promise.all(uploads).then(function () {
        console.log('アップロード完了');
      });
    });

    // APIサーバーに送信してトークン発行しちゃえ
      // 名義はtestuidで発行

    // サーバへ送りたいデータ
    const data = {uid:"testuid", data: "gs://tap-f4f38.appspot.com/tmp/" + filename};

    // FetchAPIのオプション準備
    const param  = {
      mode: 'cors',
      method: "POST",
      headers: { "Content-Type": "application/json;" },
      body: JSON.stringify(data)
    };

    // paramを付ける以外はGETと同じ
    fetch("https://tap-api.shmn7iii.net/tokens", param)
      .then((res)=>{
        return( res.json() );
      })
      .then((json)=>{
        token_id = json['data']['token_id']
        const tokenMessage = `
            <p>token_id: ` + token_id + `</p>
        `;
        document.getElementById('token').innerHTML = tokenMessage;
      });
  </script>

</body>
</html>